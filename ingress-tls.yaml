apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-python-ingress
  namespace: azure-store-1758905293727
  annotations:
    # 1. Anotação legada para compatibilidade, embora ingressClassName seja preferida.
    kubernetes.io/ingress.class: nginx 

    # 2. **ATIVAÇÃO:** Anotação para o Cert-Manager
    # Diz ao cert-manager para usar o ClusterIssuer que criamos.
    cert-manager.io/cluster-issuer: letsencrypt-prod

    # 3. **ATIVAÇÃO:** Força o NGINX a redirecionar HTTP (porta 80) para HTTPS (porta 443).
    # Esta anotação deve estar ativa para garantir a segurança da comunicação.
    nginx.ingress.kubernetes.io/ssl-redirect: "true" 
    
    # 4. Anotação Azure (Geralmente não é necessária se você instalou o NGINX via Helm/Add-on)
    service.beta.kubernetes.io/azure-load-balancer-inbound-nat-rules: '[{"protocol": "tcp", "backendPort": 80, "frontendPort": 80}, {"protocol": "tcp", "backendPort": 443, "frontendPort": 443}]'

spec:
  # 5. **CORREÇÃO ESSENCIAL:** Define a classe do Ingress Controller
  ingressClassName: nginx 

  rules:
  - host: hello-python-aks.duckdns.org
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: hello-python-service
            port:
              # O Ingress sempre conversa com o Service na porta do Service (80), 
              # que por sua vez, roteia para o TargetPort (8080) do Pod.
              number: 80 

  # 6. Seção TLS: Habilita o HTTPS e especifica o Secret onde o certificado será salvo.
  tls:
  - hosts:
    - hello-python-aks.duckdns.org
    secretName: hello-python-tls-secret